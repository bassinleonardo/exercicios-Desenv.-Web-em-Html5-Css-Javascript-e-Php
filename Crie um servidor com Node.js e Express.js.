// server.js
const express = require('express');
const bodyParser = require('body-parser');
const MongoClient = require('mongodb').MongoClient;

const app = express();
const port = 3000;

app.use(bodyParser.json());
app.use(express.static('public'));

let db;

MongoClient.connect('mongodb://localhost:27017', { useNewUrlParser: true, useUnifiedTopology: true })
    .then(client => {
        db = client.db('meubanco');
        app.listen(port, () => {
            console.log(`Servidor rodando em http://localhost:${port}`);
        });
    })
    .catch(error => console.error(error));

app.post('/api/login', (req, res) => {
    const { username, password } = req.body;
    db.collection('usuarios').findOne({ username, password })
        .then(user => {
            if (user) {
                res.status(200).send();
            } else {
                res.status(401).send();
            }
        })
        .catch(error => res.status(500).send(error));
});

app.get('/api/info', (req, res) => {
    db.collection('info').find().toArray()
        .then(results => res.json(results))
        .catch(error => res.status(500).send(error));
});

app.get('/api/buscar', (req, res) => {
    const info = req.query.info;
    db.collection('info').findOne({ info })
        .then(result => {
            if (result) {
                res.json({ exists: true });
            } else {
                res.json({ exists: false });
            }
        })
        .catch(error => res.status(500).send(error));
});
